#!/usr/bin/env ruby

$: << File.join(File.dirname(__FILE__), "..")

require 'rubygems'
require 'lib/programs/agent'
require 'lib/program'
require 'logger'
require 'optparse'

$progname = File.basename($0)
$version = "0.3"
$logger = Logger.new(STDOUT)
$logger.level = Logger::INFO
$logger.progname = $progname
$logger.datetime_format = "%Y-%m-%d %H:%M:%S"

def main(args)
  options = parse_options(args)
  return LogStash::Programs::Agent.new(options).run
end # def main

def parse_options(args)
  options = {:daemonize => true,
             :logfile => nil,
             :pidfile => nil,
             :config => nil,
            }

  opts = OptionParser.new do |opts|
    opts.banner = "Usage: logstash-agent [options] configfile"
    opts.version = $version

    opts.on("-d", "--debug", "Enable debug output") do |x|
      $logger.level = Logger::DEBUG
    end

    opts.on("--pidfile FILE", "Path to pidfile") do |x|
      options[:pidfile] = x
    end

    opts.on("-f", "--foreground", "Do not daemonize") do |x|
      options[:daemonize] = false
    end

    opts.on("-l FILE", "--logfile FILE", "File path to put logs") do |x|
      options[:logfile] = x
    end
  end

  begin
    opts.order!(args)
  rescue
    $stderr.puts "#{$progname}: #{$!}"
    $stderr.puts opts
    exit(1)
  end

  if args.length != 1
    $stderr.puts "#{$progname}: must specify exactly one config file"
    $stderr.puts opts
    exit(1)
  end
  options[:config] = args.shift

  return options  
end # def parse_options

exit main(ARGV)
