#summary Network Protocol Documentation

= General Network Protocol =

General: JSON over TCP.
Wire encoding: [length][message data]

  * length is a 4 byte integer representing the length of the message.
  * message data is plain text json.

:: In the future, we may accept compressed data instead of plain text json
data. The first few bytes of the 'data' portion can be used to determine if the
data is compressed and by what means. However, we do not currently support compression. ::

== Base Protocol ==

{{{
{ version: <version>.
  messages: [
    <message>,
    <message 2>,
    ...
    <message N>,
  ]
}
}}}

== Basic Request ==

{{{
{ request: <function>,
  id: <unique id>,
  args: {
    <args>
  },
}
}}}
  
  * The unique id is for the receiver to respond (if required) to the message.

== Basic Response ==

{{{
{ response: <function>,
  id: <unique id>,
  args: {
    <args>
  },
}
}}}
  
  * The unique id is for the receiver to respond (if required) to the message.

= Specific Messages ==

== IndexEvent Request ==

Sender: Agent
Receiver: Indexer

Purpose: Tell the indexer to index a new event.

{{{
{ request: "IndexEvent"
  id: <id>
  args: {
    type: <string : log type>,
    message: <string OR object : log data>,
    metadata: {
      source_host: <string : hostname originating the event>
      source_app: <string : app originating the event>
      <other attributes here>
    },
  },
}
}}}

  * "log_type" is the log type. Log types are defined on the Indexer.
  * "message" is the contents of the event. It can be a string (ie; line from a logfile) or a full JSON object.
  * metadata contains other attributes relative to this event. At a minimum, the Agent should include the source host and application.

== IndexEvent message response ==

Sender: Indexer
Receiver: Agent

Purpose: Acknowledge successful receipt of an event and report any errors.

{{{
{ response: "IndexEvent"
  id: <id>
  args: {
    code: <integer : IndexEvent_response_code>
    error: "error message"               # optional
  }
}
}}}

  * "code" should be the return code from the IndexEvent request. Zero (0) means success and acknowledgement.
  * "error" is an optional error message. There will be no message if the code is 0.


=== Example IndexEvent conversation ===


From Agent to Indexer:
{{{
{ version: 1
  messages: [
    { request: "IndexEvent",
      id: 100,
      args {
        type: "apache",
        message: "65.57.245.11 - - [03/Oct/2006:18:38:03 ...",
        metadata: {
          source_host: "web2.example.com",
          source_app: "apache2",
        }
      }
    }
  ]
}
}}}

From Indexer to Agent:
{{{
{ version: 1
  messages: [
    { response: "IndexEvent",
      id: 100,
      args {
        code: 0,
      }
    }
  ]
}
}}}